<div class="backtesting">
  <div class="header">
    <h1>Backtesting</h1>
    <p>Test your trading strategies on historical data</p>
  </div>

  <div class="controls-panel">
    <div class="control-group">
      <label>Strategy</label>
      <select [(ngModel)]="selectedStrategy" (change)="onStrategyChange()">
        <option [value]="null">Select a strategy</option>
        <option *ngFor="let strategy of strategies" [value]="strategy.id">
          {{ strategy.name }}
        </option>
      </select>
    </div>

    <div class="control-group">
      <label>Symbol</label>
      <select [(ngModel)]="selectedSymbol">
        <option *ngFor="let symbol of symbols" [value]="symbol">
          {{ symbol }}
        </option>
      </select>
    </div>

    <div class="control-group">
      <label>Timeframe</label>
      <select [(ngModel)]="selectedInterval">
        <option *ngFor="let interval of intervals" [value]="interval.value">
          {{ interval.label }}
        </option>
      </select>
    </div>

    <div class="control-group">
      <label>Initial Capital (USDT)</label>
      <input type="number" [(ngModel)]="initialCapital" min="100" step="100" />
    </div>

    <button
      class="btn-run"
      (click)="runBacktest()"
      [disabled]="!selectedStrategy || isRunning">
      {{ isRunning ? 'Running...' : 'Run Backtest' }}
    </button>

    <button
      class="btn-compare"
      (click)="runMultiTimeframeBacktest()"
      [disabled]="!selectedStrategy || isRunning">
      {{ isRunning ? 'Running...' : 'Compare All Timeframes' }}
    </button>

    <button
      class="btn-optimize"
      (click)="toggleOptimization()"
      [disabled]="!selectedStrategy">
      {{ showOptimization ? '‚úï Close Optimizer' : 'üîß Optimize Parameters' }}
    </button>
  </div>

  <div *ngIf="isLoading" class="loading">
    <div class="spinner"></div>
    <p>Loading historical data and running backtest...</p>
  </div>

  <!-- Parameter Optimization -->
  <div *ngIf="showOptimization && !isLoading" class="optimization-panel">
    <h2>Parameter Optimization</h2>
    <p class="optimization-description">
      Use grid search to find the best parameters for your strategy by testing all combinations within the specified ranges.
    </p>

    <div class="optimization-config">
      <div class="control-group">
        <label>Optimization Metric</label>
        <select [(ngModel)]="selectedOptimizationMetric">
          <option *ngFor="let metric of optimizationMetrics" [value]="metric">
            {{ getOptimizationMetricLabel(metric) }}
          </option>
        </select>
      </div>

      <div class="parameter-ranges">
        <h3>Parameter Ranges</h3>

        <div *ngFor="let range of parameterRanges; let i = index" class="parameter-range">
          <div class="range-row">
            <div class="control-group">
              <label>Parameter</label>
              <input type="text" [(ngModel)]="range.name" />
            </div>
            <div class="control-group">
              <label>Min</label>
              <input type="number" [(ngModel)]="range.min" step="0.1" />
            </div>
            <div class="control-group">
              <label>Max</label>
              <input type="number" [(ngModel)]="range.max" step="0.1" />
            </div>
            <div class="control-group">
              <label>Step</label>
              <input type="number" [(ngModel)]="range.step" step="0.1" />
            </div>
            <div class="control-group">
              <label>Type</label>
              <select [(ngModel)]="range.type">
                <option value="integer">Integer</option>
                <option value="decimal">Decimal</option>
              </select>
            </div>
            <button class="btn-remove" (click)="removeParameterRange(i)">‚úï</button>
          </div>
        </div>

        <button class="btn-add-range" (click)="addParameterRange()">
          ‚ûï Add Parameter Range
        </button>
      </div>

      <div class="optimization-actions">
        <button
          class="btn-optimize"
          (click)="runOptimization()"
          [disabled]="isRunning || parameterRanges.length === 0">
          {{ isRunning ? 'Optimizing...' : 'üöÄ Run Optimization' }}
        </button>
        <button
          *ngIf="isRunning"
          class="btn-cancel"
          (click)="cancelOptimization()">
          Cancel
        </button>
      </div>

      <div *ngIf="optimizationProgress && optimizationProgress.status === 'running'" class="optimization-progress">
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="optimizationProgress.percentage"></div>
        </div>
        <p>Testing {{ optimizationProgress.current }} / {{ optimizationProgress.total }} combinations ({{ optimizationProgress.percentage.toFixed(1) }}%)</p>
      </div>
    </div>

    <!-- Optimization Results -->
    <div *ngIf="optimizationResults.length > 0" class="optimization-results">
      <div class="results-header">
        <h3>Optimization Results ({{ optimizationResults.length }} combinations tested)</h3>
        <button class="btn-apply" (click)="applyBestParameters()">
          ‚úì Apply Best Parameters to Strategy
        </button>
      </div>

      <div class="results-table-container table-responsive">
        <table class="results-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Score</th>
              <th>Total Return</th>
              <th>Win Rate</th>
              <th>Sharpe</th>
              <th>Profit Factor</th>
              <th>Max DD</th>
              <th>Parameters</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let result of optimizationResults.slice(0, 20); let i = index"
                [class.best-result]="i === 0">
              <td>{{ i + 1 }}</td>
              <td>{{ formatOptimizationScore(result.score, selectedOptimizationMetric) }}</td>
              <td [class.positive]="result.results.totalProfit > 0">
                {{ formatCurrency(result.results.totalProfit) }}<br>
                <small>{{ formatPercent(result.results.totalProfitPercent) }}</small>
              </td>
              <td>{{ formatPercent(result.results.winRate) }}</td>
              <td>{{ formatNumber(result.results.sharpeRatio) }}</td>
              <td>{{ formatNumber(result.results.profitFactor) }}</td>
              <td class="negative">{{ formatPercent(result.results.maxDrawdownPercent) }}</td>
              <td class="parameters-cell">
                <span *ngFor="let param of result.parameters | keyvalue" class="param-tag">
                  {{ getParameterName(param.key) }}: {{ param.value }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Multi-Timeframe Comparison Results -->
  <div *ngIf="multiTimeframeResults && multiTimeframeResults.length > 0 && !isLoading" class="comparison-results">
    <h2>Timeframe Comparison Results</h2>

    <div *ngIf="bestTimeframe" class="best-timeframe-card">
      <h3>üèÜ Best Performing Timeframe</h3>
      <div class="best-tf-info">
        <span class="timeframe">{{ bestTimeframe.timeframe }}</span>
        <span class="profit" [class.positive]="bestTimeframe.totalProfit > 0">
          {{ formatCurrency(bestTimeframe.totalProfit) }} ({{ formatPercent(bestTimeframe.totalProfitPercent) }})
        </span>
        <span class="win-rate">Win Rate: {{ formatPercent(bestTimeframe.winRate) }}</span>
        <span class="sharpe">Sharpe: {{ formatNumber(bestTimeframe.sharpeRatio) }}</span>
      </div>
    </div>

    <div class="comparison-table-container table-responsive">
      <table class="comparison-table">
        <thead>
          <tr>
            <th>Timeframe</th>
            <th>Total Return</th>
            <th>Win Rate</th>
            <th>Profit Factor</th>
            <th>Sharpe Ratio</th>
            <th>Max Drawdown</th>
            <th>Total Trades</th>
            <th>Avg Trade</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let result of multiTimeframeResults" [class.best-row]="result.timeframe === bestTimeframe?.timeframe">
            <td class="timeframe-cell">{{ result.timeframe }}</td>
            <td [class.positive]="result.totalProfit > 0" [class.negative]="result.totalProfit < 0">
              {{ formatCurrency(result.totalProfit) }}<br>
              <small>{{ formatPercent(result.totalProfitPercent) }}</small>
            </td>
            <td>{{ formatPercent(result.winRate) }}</td>
            <td [class.good]="result.profitFactor > 1.5" [class.poor]="result.profitFactor < 1">
              {{ formatNumber(result.profitFactor) }}
            </td>
            <td [class.good]="result.sharpeRatio > 1" [class.poor]="result.sharpeRatio < 0">
              {{ formatNumber(result.sharpeRatio) }}
            </td>
            <td class="negative">{{ formatPercent(result.maxDrawdownPercent) }}</td>
            <td>{{ result.totalTrades }}</td>
            <td [class.positive]="result.averageProfit > 0" [class.negative]="result.averageProfit < 0">
              {{ formatCurrency(result.averageProfit) }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div *ngIf="results && !isLoading" class="results">
    <!-- Performance Metrics -->
    <div class="metrics-section">
      <h2>Performance Metrics</h2>
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-label">Total Return</div>
          <div class="metric-value" [class.positive]="results.totalProfit > 0" [class.negative]="results.totalProfit < 0">
            {{ formatCurrency(results.totalProfit) }}
            <span class="metric-subtitle">{{ formatPercent(results.totalProfitPercent) }}</span>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-label">Win Rate</div>
          <div class="metric-value">
            {{ formatPercent(results.winRate) }}
            <span class="metric-subtitle">{{ results.winningTrades }}/{{ results.totalTrades }} trades</span>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-label">Profit Factor</div>
          <div class="metric-value">
            {{ formatNumber(results.profitFactor) }}
            <span class="metric-subtitle">{{ results.profitFactor > 1 ? 'Good' : 'Poor' }}</span>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-label">Max Drawdown</div>
          <div class="metric-value negative">
            {{ formatCurrency(results.maxDrawdown) }}
            <span class="metric-subtitle">{{ formatPercent(results.maxDrawdownPercent) }}</span>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-label">Sharpe Ratio</div>
          <div class="metric-value">
            {{ formatNumber(results.sharpeRatio) }}
            <span class="metric-subtitle">{{ results.sharpeRatio > 1 ? 'Good' : 'Fair' }}</span>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-label">Avg Profit/Trade</div>
          <div class="metric-value" [class.positive]="results.averageProfit > 0" [class.negative]="results.averageProfit < 0">
            {{ formatCurrency(results.averageProfit) }}
            <span class="metric-subtitle">{{ formatPercent(results.averageProfitPercent) }}</span>
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-label">Start Balance</div>
          <div class="metric-value">
            {{ formatCurrency(results.startBalance) }}
          </div>
        </div>

        <div class="metric-card">
          <div class="metric-label">End Balance</div>
          <div class="metric-value" [class.positive]="results.endBalance > results.startBalance" [class.negative]="results.endBalance < results.startBalance">
            {{ formatCurrency(results.endBalance) }}
            <span class="metric-subtitle">ROI: {{ formatPercent(results.roi) }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart -->
    <div class="chart-section">
      <div class="chart-header">
        <h2>Price Chart with Signals</h2>
        <button class="btn-export" (click)="exportResults()">Export Results</button>
      </div>
      <div #chartContainer class="chart-container"></div>
    </div>

    <!-- Trade List -->
    <div class="trades-section">
      <h2>Trade History ({{ results.totalTrades }} trades)</h2>
      <div class="trades-table-container table-responsive">
        <table class="trades-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Entry Time</th>
              <th>Exit Time</th>
              <th>Entry Price</th>
              <th>Exit Price</th>
              <th>Quantity</th>
              <th>Profit/Loss</th>
              <th>%</th>
              <th>Entry Reason</th>
              <th>Exit Reason</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let trade of results.trades; let i = index" [class]="getTradeColor(trade)">
              <td>{{ i + 1 }}</td>
              <td>{{ formatDate(trade.entryTime) }}</td>
              <td>{{ trade.exitTime ? formatDate(trade.exitTime) : 'Open' }}</td>
              <td>{{ formatCurrency(trade.entryPrice) }}</td>
              <td>{{ trade.exitPrice ? formatCurrency(trade.exitPrice) : '-' }}</td>
              <td>{{ formatNumber(trade.quantity, 4) }}</td>
              <td [class.positive]="(trade.profit || 0) > 0" [class.negative]="(trade.profit || 0) < 0">
                {{ trade.profit ? formatCurrency(trade.profit) : '-' }}
              </td>
              <td [class.positive]="(trade.profitPercent || 0) > 0" [class.negative]="(trade.profitPercent || 0) < 0">
                {{ trade.profitPercent ? formatPercent(trade.profitPercent) : '-' }}
              </td>
              <td>{{ trade.entrySignal.reason }}</td>
              <td>{{ trade.exitSignal?.reason || '-' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Signals List -->
    <div class="signals-section">
      <h2>All Signals ({{ results.signals.length }} signals)</h2>
      <div class="signals-table-container table-responsive">
        <table class="signals-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Time</th>
              <th>Type</th>
              <th>Price</th>
              <th>Reason</th>
              <th>RSI</th>
              <th>SMA20</th>
              <th>SMA50</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let signal of results.signals; let i = index"
                [class.buy]="signal.type === 'BUY' || signal.type === 'GOLDEN_CROSS'"
                [class.sell]="signal.type === 'SELL' || signal.type === 'DEATH_CROSS'">
              <td>{{ i + 1 }}</td>
              <td>{{ formatDate(signal.time) }}</td>
              <td><span class="signal-badge">{{ signal.type }}</span></td>
              <td>{{ formatCurrency(signal.price) }}</td>
              <td>{{ signal.reason }}</td>
              <td>{{ signal.rsi ? formatNumber(signal.rsi) : '-' }}</td>
              <td>{{ signal.sma20 ? formatCurrency(signal.sma20) : '-' }}</td>
              <td>{{ signal.sma50 ? formatCurrency(signal.sma50) : '-' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
