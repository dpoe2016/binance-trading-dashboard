<div class="strategy-manager">
  <div class="header">
    <h2>Strategieverwaltung</h2>
    <button class="btn-add" (click)="toggleAddForm()">
      {{ showAddForm ? 'Abbrechen' : '+ Neue Strategie' }}
    </button>
  </div>

  <!-- Add Strategy Form -->
  <div class="add-form" *ngIf="showAddForm">
    <h3>Neue Handelsstrategie erstellen</h3>

    <div class="form-group">
      <label for="name">Name *</label>
      <input type="text" id="name" [(ngModel)]="newStrategy.name" placeholder="z.B. RSI Oversold/Overbought">
    </div>

    <div class="form-group">
      <label for="description">Beschreibung</label>
      <textarea id="description" [(ngModel)]="newStrategy.description" rows="2" placeholder="Beschreiben Sie Ihre Strategie..."></textarea>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="symbol">Symbol *</label>
        <select id="symbol" [(ngModel)]="newStrategy.symbol">
          <option *ngFor="let sym of symbols" [value]="sym">{{ sym }}</option>
        </select>
      </div>

      <div class="form-group">
        <label for="timeframe">Zeitrahmen</label>
        <select id="timeframe" [(ngModel)]="newStrategy.timeframe">
          <option *ngFor="let tf of timeframes" [value]="tf">{{ tf }}</option>
        </select>
      </div>

      <div class="form-group">
        <label for="quantity">Menge</label>
        <input type="text" id="quantity" [(ngModel)]="newStrategy.quantity" placeholder="0.001">
      </div>
    </div>

    <div class="form-group">
      <label>
        <input type="checkbox" [(ngModel)]="newStrategy.usePineScript">
        Pine Script verwenden
      </label>
    </div>

    <div class="form-group" *ngIf="newStrategy.usePineScript">
      <label for="pineScript">Pine Script Code</label>
      <textarea id="pineScript" [(ngModel)]="newStrategy.pineScript" rows="10" placeholder="Geben Sie Ihren Pine Script Code ein..."></textarea>
      <button class="btn-example" (click)="usePineScriptExample()">Beispiel laden</button>
    </div>

    <div class="form-group" *ngIf="!newStrategy.usePineScript">
      <label>
        <input type="checkbox" [(ngModel)]="newStrategy.useRSI">
        RSI-basierte Strategie (Kaufen bei RSI < 30, Verkaufen bei RSI > 70)
      </label>
    </div>

    <div class="form-group" *ngIf="!newStrategy.usePineScript">
      <label>
        <input type="checkbox" [(ngModel)]="newStrategy.useAroon">
        Aroon Indikator anzeigen (Trendstärke und -richtung)
      </label>
    </div>

    <div class="form-row" *ngIf="!newStrategy.usePineScript && newStrategy.useAroon">
      <div class="form-group">
        <label for="aroonPeriod">Aroon Periode</label>
        <input type="number" id="aroonPeriod" [(ngModel)]="newStrategy.aroonPeriod" placeholder="25" min="5" max="100">
      </div>
    </div>

    <div class="form-group">
      <label>
        <input type="checkbox" [(ngModel)]="newStrategy.autoExecute">
        Automatische Ausführung (Trades werden automatisch platziert)
      </label>
    </div>

    <div class="form-actions">
      <button class="btn-cancel" (click)="toggleAddForm()">Abbrechen</button>
      <button class="btn-save" (click)="addStrategy()">Strategie speichern</button>
    </div>
  </div>

  <!-- Strategies List -->
  <div class="strategies-list">
    <div class="strategy-card" *ngFor="let strategy of strategies">
      <div class="strategy-header">
        <div class="strategy-title">
          <h3 *ngIf="!isEditing(strategy.id)">{{ strategy.name }}</h3>
          <input *ngIf="isEditing(strategy.id)" class="edit-input" type="text" [(ngModel)]="editingStrategy.name" placeholder="Name">
          <span class="status-badge" [class.active]="strategy.isActive" [class.inactive]="!strategy.isActive">
            {{ strategy.isActive ? 'Aktiv' : 'Inaktiv' }}
          </span>
        </div>
        <div class="strategy-actions">
          <ng-container *ngIf="!isEditing(strategy.id)">
            <button class="btn-toggle" (click)="toggleStrategy(strategy.id, !strategy.isActive)">
              {{ strategy.isActive ? 'Stoppen' : 'Starten' }}
            </button>
            <button class="btn-edit" (click)="startEditStrategy(strategy)">Bearbeiten</button>
            <button class="btn-delete" (click)="deleteStrategy(strategy.id)">Löschen</button>
          </ng-container>
          <ng-container *ngIf="isEditing(strategy.id)">
            <button class="btn-save" (click)="saveEditedStrategy()">Speichern</button>
            <button class="btn-cancel-edit" (click)="cancelEditStrategy()">Abbrechen</button>
          </ng-container>
        </div>
      </div>

      <div class="strategy-body">
        <p class="description" *ngIf="!isEditing(strategy.id) && strategy.description">{{ strategy.description }}</p>
        <textarea *ngIf="isEditing(strategy.id)" class="edit-textarea" [(ngModel)]="editingStrategy.description" rows="2" placeholder="Beschreibung"></textarea>

        <div class="strategy-details">
          <div class="detail-item">
            <span class="label">Symbol:</span>
            <span class="value" *ngIf="!isEditing(strategy.id)">{{ strategy.symbol }}</span>
            <select *ngIf="isEditing(strategy.id)" class="edit-select" [(ngModel)]="editingStrategy.symbol">
              <option *ngFor="let sym of symbols" [value]="sym">{{ sym }}</option>
            </select>
          </div>
          <div class="detail-item">
            <span class="label">Zeitrahmen:</span>
            <span class="value" *ngIf="!isEditing(strategy.id)">{{ strategy.timeframe }}</span>
            <select *ngIf="isEditing(strategy.id)" class="edit-select" [(ngModel)]="editingStrategy.timeframe">
              <option *ngFor="let tf of timeframes" [value]="tf">{{ tf }}</option>
            </select>
          </div>
          <div class="detail-item">
            <span class="label">Letzte Ausführung:</span>
            <span class="value">{{ formatDate(strategy.lastExecuted) }}</span>
          </div>
        </div>

        <div class="pine-script-indicator" *ngIf="strategy.pineScript">
          <span class="indicator-badge">Pine Script aktiviert</span>
        </div>

        <div class="strategy-parameters">
          <strong>Parameter:</strong>

          <!-- View mode -->
          <ul *ngIf="!isEditing(strategy.id)">
            <li *ngFor="let param of strategy.parameters | keyvalue">
              {{ param.key }}: {{ param.value }}
            </li>
          </ul>

          <!-- Edit mode -->
          <div class="parameters-edit" *ngIf="isEditing(strategy.id) && editingStrategy.parameters">
            <div class="param-item">
              <label>
                <input type="checkbox" [(ngModel)]="editingStrategy.parameters!['useRSI']">
                RSI verwenden
              </label>
            </div>

            <div class="param-row" *ngIf="editingStrategy.parameters!['useRSI']">
              <div class="param-item">
                <label>RSI Überverkauft</label>
                <input type="number" [(ngModel)]="editingStrategy.parameters!['rsiOversold']" placeholder="30" min="0" max="100">
              </div>
              <div class="param-item">
                <label>RSI Überkauft</label>
                <input type="number" [(ngModel)]="editingStrategy.parameters!['rsiOverbought']" placeholder="70" min="0" max="100">
              </div>
            </div>

            <div class="param-item">
              <label>
                <input type="checkbox" [(ngModel)]="editingStrategy.parameters!['useSMA']">
                SMA verwenden
              </label>
            </div>

            <div class="param-item">
              <label>
                <input type="checkbox" [(ngModel)]="editingStrategy.parameters!['useSMA200']">
                SMA 200 verwenden
              </label>
            </div>

            <div class="param-item">
              <label>
                <input type="checkbox" [(ngModel)]="editingStrategy.parameters!['useAroon']">
                Aroon Indikator verwenden
              </label>
            </div>

            <div class="param-item" *ngIf="editingStrategy.parameters!['useAroon']">
              <label>Aroon Periode</label>
              <input type="number" [(ngModel)]="editingStrategy.parameters!['aroonPeriod']" placeholder="25" min="5" max="100">
            </div>

            <div class="param-item">
              <label>Menge</label>
              <input type="text" [(ngModel)]="editingStrategy.parameters!['quantity']" placeholder="0.001">
            </div>

            <div class="param-item">
              <label>
                <input type="checkbox" [(ngModel)]="editingStrategy.parameters!['autoExecute']">
                Automatische Ausführung
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="no-strategies" *ngIf="strategies.length === 0 && !showAddForm">
      <p>Keine Strategien vorhanden. Erstellen Sie Ihre erste Handelsstrategie!</p>
      <button class="btn-add-large" (click)="toggleAddForm()">+ Strategie erstellen</button>
    </div>
  </div>
</div>
